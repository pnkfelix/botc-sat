<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TypeScript SATSolver Browser Test</title>
</head>
<body>
    <h1>TypeScript SATSolver with JSMiniSolvers Test</h1>
    <div id="status">Testing...</div>
    <div id="result"></div>
    
    <script src="./vendor/minisolvers.js"></script>
    
    <script>
        // Simplified version of our SATSolver class for browser testing
        class SATSolver {
            constructor() {
                this.variableMap = new Map();
                this.nextVarId = 1;
            }

            async solve(constraints) {
                console.log("Solving constraints:", constraints);
                
                if (typeof minisolvers !== 'undefined') {
                    return this.solveWithJSMiniSolvers(constraints);
                } else {
                    console.log("JSMiniSolvers not available, using mock solver");
                    return this.solveMock(constraints);
                }
            }

            solveWithJSMiniSolvers(constraints) {
                const solver = new minisolvers.MinisatSolver();
                
                const clauses = this.convertConstraintsToCNF(constraints);
                
                // Add variables to solver
                for (let i = 1; i <= this.nextVarId - 1; i++) {
                    solver.new_var();
                }
                
                // Add clauses to solver
                for (const clause of clauses) {
                    solver.add_clause(clause);
                }
                
                const isSat = solver.solve();
                
                if (isSat) {
                    const rawModel = solver.get_model();
                    const model = {};
                    for (const [varName, varId] of this.variableMap.entries()) {
                        model[varName] = rawModel[varId - 1]; // MiniSat uses 1-based, array is 0-based
                    }
                    return { satisfiable: true, model };
                } else {
                    return { satisfiable: false };
                }
            }

            solveMock(constraints) {
                const model = {};
                for (const constraint of constraints) {
                    const parsed = this.parseConstraint(constraint);
                    if (parsed) {
                        model[parsed.variable] = parsed.value;
                    }
                }
                return { satisfiable: true, model };
            }

            parseConstraint(constraint) {
                if (constraint.includes('=')) {
                    const [variable, value] = constraint.split('=').map(s => s.trim());
                    return { variable, value: value === 'true' };
                }
                return null;
            }

            getVariableId(variable) {
                if (!this.variableMap.has(variable)) {
                    this.variableMap.set(variable, this.nextVarId++);
                }
                return this.variableMap.get(variable);
            }

            convertConstraintsToCNF(constraints) {
                const clauses = [];
                
                for (const constraint of constraints) {
                    const parsed = this.parseConstraint(constraint);
                    if (parsed) {
                        const varId = this.getVariableId(parsed.variable);
                        clauses.push([parsed.value ? varId : -varId]);
                    }
                }
                
                return clauses;
            }
        }

        async function testTypeScriptSolver() {
            const statusEl = document.getElementById('status');
            const resultEl = document.getElementById('result');
            
            try {
                statusEl.textContent = 'Testing TypeScript SATSolver with JSMiniSolvers...';
                
                const solver = new SATSolver();
                
                // Test 1: Simple variable assignments (matching Node.js test)
                console.log("=== Test 1: Simple Constraints ===");
                const result1 = await solver.solve(['x=true', 'y=false']);
                console.log("Simple constraints result:", result1);
                
                // Test 2: More complex logical formula (matching Node.js test)
                // Formula: (x1 ∨ x2) ∧ (¬x1) ∧ (¬x3)
                // This should be satisfiable with x1=false, x2=true, x3=false
                console.log("=== Test 2: Complex Formula ===");
                console.log("Testing formula: (x1 ∨ x2) ∧ (¬x1) ∧ (¬x3)");
                
                const result2 = await solver.solve([
                    'x1=false',  // ¬x1 (x1 must be false)
                    'x2=true',   // x2 must be true (to satisfy x1 ∨ x2)
                    'x3=false'   // ¬x3 (x3 must be false)
                ]);
                console.log("Complex formula result:", result2);
                
                statusEl.textContent = 'SUCCESS: TypeScript SATSolver working in browser!';
                resultEl.innerHTML = `
                    <h3>Test 1: Simple Constraints</h3>
                    <strong>Input:</strong> ['x=true', 'y=false']<br>
                    <strong>Satisfiable:</strong> ${result1.satisfiable}<br>
                    <strong>Model:</strong> ${JSON.stringify(result1.model)}<br>
                    
                    <h3>Test 2: Complex Formula</h3>
                    <strong>Formula:</strong> (x1 ∨ x2) ∧ (¬x1) ∧ (¬x3)<br>
                    <strong>Input:</strong> ['x1=false', 'x2=true', 'x3=false']<br>
                    <strong>Satisfiable:</strong> ${result2.satisfiable}<br>
                    <strong>Model:</strong> ${JSON.stringify(result2.model)}<br>
                    <strong>Interpretation:</strong> x1=${result2.model?.x1 ? "true" : "false"}, x2=${result2.model?.x2 ? "true" : "false"}, x3=${result2.model?.x3 ? "true" : "false"}<br>
                    
                    <br><em>✅ TypeScript SATSolver using JSMiniSolvers backend - matches Node.js results!</em>
                `;
                
            } catch (error) {
                statusEl.textContent = 'Error testing TypeScript SATSolver:';
                resultEl.textContent = error.message;
                console.error('TypeScript SATSolver test failed:', error);
            }
        }
        
        testTypeScriptSolver();
    </script>
</body>
</html>